10 'save"AUTOEXEC.BAS"
20 _IOTINIT()
30 WIDTH 32:KEY OFF:COLOR 1,2,2:SCREEN 5:_KANJI
40 CLEAR 2048,&HB000:DEFINT A-Z
50 BLOAD "JSON.BIN",R
60 BLOAD "LDIRSTR.BIN":DEFUSR3=&HD800
70 DIM KY$(100)
80 DQ$=CHR$(&H22):NL$=CHR$(13)+CHR$(10):HE$=NL$+NL$
90 'user setting
100 LC$="280010"
110 '
120 PA$="msx/me/if/NET0/"  'path
130 UR$="weather.tsukumijima.net"
140 'create message
160 SM$(0)="GET /api/forecast/city/"+LC$+" HTTP/1.0"+NL$
170 SM$(1)="Host: "+UR$+NL$
180 SM$(2)=""+NL$
190 SM$(3)=CN$
200 SM$(4)=""
210 '
220 ON INTERVAL=36000! GOSUB 440
230 SET PAGE 0,1
240 BLOAD "FONT.SC5",S
250 COLOR=RESTORE
260 SETPAGE 0,0
270 COPY (8,136)-(98,164),1 TO (10,90),0
280 COPY (60,90)-(90,120),1 TO (210,90),0
290 COPY (8,166)-(98,194),1 TO (10,150),0
300 COPY (30,90)-(60,120),1 TO (210,150),0
310 INTERVAL ON:DO$=""
320 GET TIME DT$:IF DO$<>DT$ THEN DO$=DT$:DX=0:DY=20:GOSUB 370 ELSE 320
330 _IOTGET("device/dht/temperature",A):DT$=RIGHT$("   "+STR$(A),3):DX=110:DY=80:GOSUB 370
340 _IOTGET("device/dht/humidity",A):DT$=RIGHT$("   "+STR$(A),3):DX=110:DY=140:GOSUB 370
350 IF ID$="" THEN GOSUB 440
360 GOTO 320
370 FOR I=1 TO LEN(DT$):A$=MID$(DT$,I,1)
380 IF A$=":" THEN PX=0:PY=83:GOTO 420
390 IF A$=" " THEN PX=150:PY=0:GOTO 420
400 IF A$="-" THEN PX=150:PY=40:GOTO 420
410 A=VAL(A$):PX=(AMOD5)*30:PY=-(A>4)*40
420 COPY (PX,PY+1)-(PX+29,PY+42),1 TO (DX+I*30-30,DY),0
430 NEXT:RETURN
440 '--------
450 'connet
460   _IOTPUT(PA$+ "conf/addr",UR$)
470   _IOTPUT(PA$+ "conf/port",80)
480   _IOTPUT(PA$+ "connect",1)
490 'check connect status
500   FOR I=0 TO 1000:NEXT
510   _IOTGET(PA$+ "connect",S)
520   IF S<>1 THEN 710
530 'send message
540   I=0
550   IF SM$(I)<>"" THEN _IOTPUT(PA$+ "msg",SM$(I)):I=I+1:GOTO 550
560   FOR I=0 TO 1000:NEXT
570 'receive message
580 P=0:NM$="":AL=0
590 AD=USR3(&HB000):MD=0:RM$=""
600 MO$=RM$:_IOTGET(PA$+ "msg",RM$):L=LEN(RM$):AL=AL+L:IF L=0 THEN 650
610 IF MD=1 THEN 630
620 R$=MO$+RM$:HP=INSTR(R$,HE$):IF HP<>0 THEN RM$=RIGHT$(R$,LEN(R$)-HP-3):MD=1 ELSE 600
630 A$=USR3(RM$)
640  GOTO 600
650 IF AL>0 THEN A=USR(&HB000) ELSE 710
660 'IF USR1("&location&city")<>0 THEN CT$=USR2("&location&city")
670 IF USR1("&forecasts#0&image&url")<>0 THEN ID$=RIGHT$(USR2("&forecasts#0&image&url"),7):GOSUB 770
680 'IF USR1("&forecasts#1&image&url")<>0 THEN ID$=RIGHT$(USR2("&forecasts#1&image&url"),7):PRINTID$
690 'IF USR1("&forecasts#2&image&url")<>0 THEN ID$=RIGHT$(USR2("&forecasts#2&image&url"),7):PRINTID$
700 'disconnet
710 _IOTPUT(PA$+ "connect",0)
720 RETURN
770 '----
780 RESTORE 810:II$=LEFT$(ID$,3)
790 READ A$,W$
800 IF A$=II$ OR A$="000" THEN COLOR 1,15,2:LINE(0,190)-(255,210),15,BF:_KLEN(L,W$):LOCATE 16-L,12:PRINT W$;:BEEP:RETURN ELSE 790
810 '-----
820 DATA 100,
830 DATA 101,ꎞX
840 DATA 102,ꎞJ
850 DATA 103,ꎞXJ
860 DATA 104,ꎞ
870 DATA 105,ꎞX
880 DATA 106,ꎞJ
890 DATA 107,ꎞXJ
900 DATA 108,ꎞJJ
910 DATA 110,̂X
920 DATA 111,̂
930 DATA 112,̂ꎞJ
940 DATA 113,̂XJ
950 DATA 114,̂J
960 DATA 115,̂ꎞ
970 DATA 116,̂X
980 DATA 117,̂
990 DATA 122,[ꎞJ
1000 DATA 123,RJ
1010 DATA 124,R
1020 DATA 125,ߌ͗J
1030 DATA 126,ꒋJ
1040 DATA 127,[J
1050 DATA 128,͉J
1060 DATA 129,锼J
1070 DATA 130,̓㐰
1080 DATA 132,꒩[
1090 DATA 140,ꎞXJŗ𔺂
1100 DATA 160,ꎞႩJ
1110 DATA 170,ꎞXႩJ
1120 DATA 181,̂ႩJ
1130 DATA 200,
1140 DATA 201,莞X
1150 DATA 202,ꎞJ
1160 DATA 203,莞XJ
1170 DATA 204,ꎞ
1180 DATA 205,莞X
1190 DATA 206,ꎞJ
1200 DATA 207,莞XJ
1210 DATA 208,ꎞJJ
1220 DATA 209,
1230 DATA 210,̂X
1240 DATA 211,̂
1250 DATA 212,̂ꎞJ
1260 DATA 213,̂XJ
1270 DATA 214,̂J
1280 DATA 215,̂ꎞ
1290 DATA 216,̂X
1300 DATA 217,̂
1310 DATA 218,̂J
1320 DATA 219,̂JJ
1330 DATA 220,蒩[ꎞJ
1340 DATA 221,蒩̓ꎞJ
1350 DATA 222,[ꎞJ
1360 DATA 223,X
1370 DATA 224,蒋J
1380 DATA 225,[J
1390 DATA 226,͉J
1400 DATA 227,锼J
1410 DATA 228,蒋
1420 DATA 229,[
1430 DATA 230,͐
1440 DATA 231,CC݂͖J
1450 DATA 260,ꎞႩJ
1460 DATA 270,莞XႩJ
1470 DATA 281,̂ႩJ
1480 DATA 300,J
1490 DATA 301,JX
1500 DATA 302,JX~
1510 DATA 303,JX
1520 DATA 304,J
1530 DATA 306,J
1540 DATA 307,Jɋ
1550 DATA 308,JŖ\𔺂
1560 DATA 309,Jꎞ
1570 DATA 311,Ĵ
1580 DATA 313,Ĵ
1590 DATA 314,ĴX
1600 DATA 315,Ĵ
1610 DATA 316,Ĵ
1620 DATA 317,Ĵ
1630 DATA 320,̓Ĵ
1640 DATA 321,̓Ĵ
1650 DATA 322,Jӈꎞ
1660 DATA 323,J琰
1670 DATA 324,J[琰
1680 DATA 325,J͐
1690 DATA 326,J[
1700 DATA 327,J͐
1710 DATA 328,Jꎞ~
1720 DATA 329,Jꎞ݂
1730 DATA 340,ႩJ
1740 DATA 350,Jŗ𔺂
1750 DATA 361,ႩĴ
1760 DATA 371,ႩĴ
1770 DATA 400,
1780 DATA 401,᎞X
1790 DATA 402,᎞X~
1800 DATA 403,᎞XJ
1810 DATA 405,
1820 DATA 406,ይ
1830 DATA 407,\
1840 DATA 409,ꎞJ
1850 DATA 411,̂
1860 DATA 413,̂
1870 DATA 414,̂J
1880 DATA 420,̓̂
1890 DATA 421,̓̂
1900 DATA 422,ᒋJ
1910 DATA 423,[J
1920 DATA 424,锼J
1930 DATA 425,ꎞ~
1940 DATA 426,݂̂
1950 DATA 427,ꎞ݂
1960 DATA 450,ŗ𔺂
1970 DATA 000,--------
